# 90D検証フロー 正本 v1.3.1（v1.3 + v26差分反映）
最終更新: 2026-01-13

この文書は **90D検証の“守るべきルール（正本）”** です。  
手順のコツ・トラブル対処・実行例は **90D虎の巻（BR_90D_TIGERBOOK.md）** を参照してください。

---

## 0) 目的（固定）
- 最上位：競艇の長期ROI最大化（全場・再現性）
- 90Dの目的：**採否を再現可能な数値で意思決定し、反映フェーズが迷わず着手できる材料（再検証キー含む）を残す**

---

## 1) WORLD（固定：混ぜない）
- **BL（analysis）**：性能評価（制約なし）
- **BT（operation）**：運用再現（CAP/除外あり）

**禁止（混在防止）**
- BLに CAP / 除外を載せる（＝analysisで --daily-cap/--exclude を渡す等）
- BL/BT成果物を同じフォルダ・同じ比較表で混ぜる（比較時は必ず WORLD を明記）

---

## 2) 期間の正（v26差分：入口で固定）
90Dは「実行日」基準ではなく **Kの実体**で期間を固定する。

- **T_end = all_k_results.csv の max(date)**（Kが存在する最終日）
- **T_start = T_end - 89日**（90日＝90日分）
- 以後、payout / features / backtest の全ては **[T_start, T_end]** を正として固定する

**重要（書式）**
- date-from/date-to は **`YYYY-MM-DD`（ハイフンあり）で統一**  
  `YYYYMMDD` を混ぜると 0件化などのサイレント縮退が起こり得るため禁止（疑わしい場合は即この点を疑う）。

---

## 3) スタート条件（入口チェック：ここが“開始”）
以下が揃ったら開始（揃ってないなら開始しない）：

- 期間固定：`T_start..T_end`（上記の定義で決定）
- payout確定：対象期間で欠損なし（payoutsが“極端に小さい/0件”は不可）
- exclusions正本が明示：`config/exclusions.json`
- official features は dedup 済み（キー固定：`date, track_norm, race_no, lane, regno`）
- baseline が明示（何と比較するか：例 BT CAP10+EXCL15 など）

> 入口チェック完了＝90Dの開始定義  
> 期間・exclusions・payouts・features 等を変えたら **別検証（別ID）** として扱う

---

## 4) 実行順序（正本：必ずこの順）
### Step A：payout確定（最優先）
- **推奨（v26差分）**：いきなり90D本番ではなく、短期チャンクで疎通（rows>0）→本番
- 成果物（必須）
  - `payouts_all_{T_start}_{T_end}*.csv`（正本）
  - 取得runlog（復旧・切り分けに必須）

### Step B：BL（analysis）実行
- 目的：制約なしの理論性能（性能評価）
- 成果物（必須）
  - `BL_*_report.csv`
  - `BL_*_diagnostic.csv`
  - `BL_*_tickets_long.csv`

### Step C：BT（operation）実行
- 目的：運用制約込みの運用再現（CAP/除外）
- 成果物（必須）
  - `BT_*_report.csv`
  - `BT_*_diagnostic.csv`
  - `BT_*_tickets_long.csv`


#### ■ 出力トレース（必須：運用に効かせたルールを“証拠”として残す）
運用ルール（buy-filter / 除外 / ケア枠など）を入れた場合、**「効いているか/どれだけ効いたか」**を毎回CSVに残す。  
“効かせたつもり”事故・世界線ズレ・再現不能を防ぐための固定ルール。

- `BT_*_diagnostic.csv`（必須）
  - `excluded_flag`（0/1）: そのRが最終的に除外されたか
  - `excluded_reason`（文字列）: 除外理由（複数なら `;` で連結）
- 集計（必須：summary/report側どちらでも可）
  - `excluded_races_count` : 除外R数
  - `excluded_races_ratio` : 除外率（除外R数 / 対象R数）

**A-4（採用済）: axis2=5/6 を買わない側へ（buy-filter）**
- diagnostic に必ず出す列
  - `excluded_by_axis2_56`（0/1）
  - `excluded_reason` に `"A-4 axis2 in {5,6}"` を含める
- 集計に必ず出す値
  - `excluded_races_count`（A-4で除外されたR数）
  - `excluded_races_ratio`


### Step D：再現性チェック（ゴール1）
- 同一期間・同一入力・同一スクリプトなら **ROI/件数/損益が一致**する（BL/BTそれぞれ）
- NGなら Step A〜C に戻って世界線ズレ原因を潰す（“データ不備”と断定しない）

### Step E：意思決定（ゴール2）— baseline vs candidate
- 判定：GO / HOLD / NO（必要なら TEMP_GO）
- 90D意思決定ルール（母数ルール・出力フォーマット・AI所感・影響成果物）は **Tigerbook内の規定**を正とする  
  （この正本はフローと禁止事項を固定し、意思決定出力は Tigerbook を参照）

---
## 4) 90Dの終わり（出口定義：ここが“終了”）
GO/HOLD/NO が確定し、対応する「出口成果物セット」＋「検証条件セット」が揃ったら90Dは終了。

### 90D中に“禁止”すること（明文化）
**禁止（NG）**
- **コード変更**（スクリプト修正・実装）
- **Cフェーズ／Dフェーズの意思決定を変えるような運用正本ドキュメントの改訂**  
  例：conf閾値、S/A運用方針、Axis-Guard方針、買い目比率などのルール変更をRUNBOOK正本に反映する行為

**許可（OK）**
- 検証結果を **検証ネタとして記録する**ための更新（＝次フェーズに渡す材料整備）
  - `LEDGER.md`（検証ネタ、判定、数値、影響成果物、次アクション）
  - 90Dの結果まとめ（結論サマリ）
  - `Tigerbook`（典型トラブル・判断フレーム・再発防止メモ）
- つまり：**運用意思決定の正本（RUNBOOK）を変えるのは反映フェーズの仕事。**  
  90Dは **“反映に必要な材料を揃えて渡す”まで。**

---

## 5) 出口成果物セット（GO/HOLD/NO別：固定）

### 5-0) 全判定共通：検証条件セット（Verification Spec）【必須】
GO/HOLD/NOにかかわらず、必ず残す（後日再検証・別フェーズ検証の再現キー）。

**必須項目（固定）**
- 検証ID（任意でOK：例 `VFY_90D_20251002_20260110_CAP10_EXCL15`）
- 期間（date_from / date_to）
- WORLD（BL/BT）
- baseline定義（何をbaselineとするか）
- candidate定義（何を変えたか）
- 制約（CAP、除外場、その他）
- 入力データの版（最低ファイル名でOK）
  - payoutsファイル名
  - features（dedup済み）ファイル名
  - exclusions（正本）ファイル名
- 実行コマンド or 実行スクリプト名（最低でもファイル名）
- 成果物ファイル名一覧（BL/BT report/diagnostic/tickets）

---

### ✅ GO（採用）—反映フェーズに「着手できる」セット
- **結論サマリ（7のフォーマット）**
- **反映スコープ（やる／やらない）**
- **影響成果物（RUNBOOK/スクリプト/出力/テスト）**
- **仕様（発火条件・買い目/金額・例外）**
- **Done条件（反映フェーズ完了定義）**
- **＋ 検証条件セット（5-0）**

---

### 🟡 HOLD（保留）—「次に何が必要か」セット
- **結論サマリ（7のフォーマット）**
- HOLD理由（1行）
- 不足条件（何R/どの追加データ/どの分割が必要か）
- 次回の最短手順（1–3手）
- **＋ 検証条件セット（5-0）**

---

### ❌ NO（不採用）—再発防止セット
- **結論サマリ（7のフォーマット）**
- NO理由（数値＋構造）
- 禁止事項（同条件・同設計では再検証しない）
- 再検討トリガー（別設計／データ量増／前提変更など）
- **＋ 検証条件セット（5-0）**

---

## 6) 反映フェーズへの引継ぎ（GOのみ：固定コピペ）
```
【反映フェーズ引継ぎ：案件ID/名称】
- 90D判定：GO
- 数値：ROI差= / 損益差= / 対象R=
- 変えること（スコープ）：
- 変えないこと（ガード）：
- 仕様（発火条件 / 追加買い目 / 例外）：
- 影響成果物（RUNBOOK/スクリプト/出力/テスト）：
- Done条件（反映完了の定義）：
- 検証条件セット（ID/期間/WORLD/baseline/candidate/制約/入力版/成果物一覧）：
```

### 6-A) 改修スコープ（ユーザ意思決定・チャット切替耐性版テンプレ）

> 反映フェーズに渡すときは、下の“改修スコープ”をそのまま埋めて渡す。  
> **ユーザが意思決定できる粒度**かつ、**切替後チャットが迷いなく着手できる粒度**を保証する。

#### ■ 触ってよい範囲（今回の改修対象）
- **変更対象：スクリプトあり**
  - **`買い目一覧の出力（例：tickets_long.csv など）`を生成している処理（スクリプト/関数）に限定（※成果物名は案件ごとに埋める）**
  - 追加するのは **「条件分岐」だけ**（既存の判定・軸選定には触れない）
- **変更対象：ドキュメントは原則なし**
  - **RUNBOOK（意思決定ルール）は変更しない**
  - 反映した事実を残すために **LEDGER（または CHANGELOG）に1行追記のみ**（推奨）

#### ■ 具体的にやる変更（WHATを固定）
- 条件：**axis2 が 5 または 6 のレース**のみ
- 追加：**ケア枠（3連複）を追加**
  - 組み合わせ：`axis1 - axis2 - (候補上位c1 or c2)`
  - 追加金額：**+400円/対象レース**（固定）
- 方式：**スイッチ方式（推奨）**
  - ON：上記ケア枠を追加
  - OFF：出力が従来と完全一致

#### ■ 触ってはいけない範囲（禁止：ここを明文化）
- conf閾値
- S/A判定ロジック
- 軸選定（axis1/axis2算出方法）
- RUNBOOKの意思決定ルール本文


#### ■ 重要：スコープ拡張は“ユーザ承認”が前提（ガード）
- 本テンプレの「触ってはいけない範囲」は **無断では触らない**（事故防止）。
- ただし **長期ROI最大化のために必要**で、あなた（ユーザ）の合意がある場合はスコープ拡張してよい。
- スコープ拡張する場合は、反映フェーズ開始前に **台帳（LEDGER）の「ユーザ承認」欄へ** ①承認有無（未/済）②承認範囲（例：conf閾値まで）③承認日 を必ず記録する。

#### ■ 完了条件（DONE：切替後でも判断できる）
- スイッチOFFで実行 → **`tickets_long` が従来と完全一致**
- スイッチONで実行 →
  - **axis2=5/6 のレースだけ**買い目が増える
  - それ以外は従来と一致



---

## 7) 意思決定の出力フォーマット（v1.3：固定）

### 結論サマリ（必須）
```
■ 結論サマリ（必須）
- 判定：GO / HOLD / NO
- ROI差／損益差（円）：
- 全体R／トリガー対象R：
- 影響成果物（採用コスト）：
- 検証条件セット（ID/期間/WORLD/baseline/candidate）：
- 総評（1行）：
- AIの所感（任意・数値を覆さない）：
```

---

## 8) 切替後AIに誤解させない注意書き（固定文）
90Dの最終出力（結論）の末尾に、必ずこの1文を付ける：

> 注意：本90Dフェーズでは「運用正本（RUNBOOK等）の意思決定ルール」は変更しない。  
> 本結果はLEDGER/Tigerbookに記録し、反映フェーズでRUNBOOK変更・実装を行う。

---

## 9) “チャット切替”耐性の最小コピペ（超短縮）
```
【90Dフロー正本 v1.3.1】
目的：採否判断＋反映着手に必要な材料（検証条件セット）を残す。
WORLD：BL(制約なし)/BT(CAP・除外あり)分離。混ぜない。
開始：期間固定＋payout確定＋exclusions正本＋dedup＋baseline明示。
順：payout→BL→BT→再現性→意思決定。
判定：ROI/円/R＋影響成果物＋検証条件セット＋所感。R>=30原則。
終了：GO/HOLD/NO確定＋出口成果物セット＋検証条件セットが揃ったら終わり。
禁止：90D中のコード変更＆運用正本（RUNBOOK）変更。記録（LEDGER等）はOK。
```

---

## 99) 今後の検討事項（タスク：LEDGER管理）
- 反映フェーズの冗長化対策（共通設計のREF外だし）は **現時点では見送り**。
  - 条件：同種案件が1〜2件増えてLEDGERが冗長になったら実施（詳細は LEDGER の [P2] を参照）
