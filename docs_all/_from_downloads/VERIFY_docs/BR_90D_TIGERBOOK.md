# 90D虎の巻（Tigerbook） 正本 v0.2（骨子＋入口要点）

## 0. この虎の巻の目的
- 90D検証で「世界線ズレ」「手順混在」「再現性崩壊」を最短で潰すための、判断・手順・典型トラブルの器。

## 1. WORLD概念（BL / BT）
- BL（analysis / 再計算・制約なし）
- BT（operation / 運用再現・CAP/除外あり）
- “混ぜると何が起きるか” のチェック観点

## 2. ゴール定義（90Dで何を確定するか）
- ゴール1：同条件なら同結果（BL/BTそれぞれ）
- ゴール2：意思決定（採用/不採用）をROI差分で固定
- 30d/90d/rolling の使い分け（窓固定の思想）

## 3. 入力と前処理の正本（何を揃えるか）
- K / fan / official features / payouts の正本
- dedupキー、key_overlap_rate、期間寄せの原則

## 4. 実行ルート（最短Runbook）
- BL（analysis）最短手順
- BT（operation）最短手順
- “やってはいけない混在” リスト（modeと制約の混在など）

## 5. 典型トラブル集（症状→原因→1行対処）
- 日付フォーマット混在（YYYYMMDD vs YYYY-MM-DD）
- Kフォルダ実体/リンク（junction問題）
- payouts不足/カバレッジ不足
- features重複（dedup漏れ）
- 固定名依存（Cフェーズ副作用）

## 6. 判断ログの残し方（再現性のための記録）
- “世界線メタ” の固定項目（期間、CAP、除外、payouts、features、commit相当）
- CANON_INDEX / guardレポートの位置づけ

## 7. 引継ぎ（HANDOVER）に必ず書くこと
- WORLD（BL/BT）明記
- 重要要素（CAP/除外/期間/正本パス）
- C側への副作用注意（固定名依存）

## 90D意思決定ルール（v1.2：AI所感欄あり）

### 目的
- ユーザが「評価の解釈」を得意でなくても、**誤採用を防ぎつつ**意思決定できるようにする。
- 判断を委ねる場合、**可能な限り数値（ROI / 金額）で提示**する。

### 最低限の母数ルール（トリガー対象R）
- 原則：トリガー対象R **>= 30** で判定する
- 例外：トリガー対象R **20–29** は「条件付き判定（TEMP_GO / HOLD）」のみ許可
- トリガー対象R **< 20** は原則 **HOLD**（判断しない）
- 例外（20–29で判断してよい条件：全て必須）
  1) 差分損益（円）が十分大きい（目安：±10万円以上／90D換算）
  2) 改修が軽微（ケア枠・条件分岐のみ／モデル本体は不変更）
  3) 副作用が限定的（全体ROIが悪化していない）
  4) 暫定扱い（TEMP_GO 等）を明示する

### 出力フォーマット（ユーザに意思決定を委ねるときは必須）
以下を必ずセットで出す（**数値→判定→所感**の順で固定）：

#### (1) 何を比べた？
- baseline：<現行運用の定義（WORLD/期間/CAP/除外/正本パス）>
- candidate：<変更点は1つだけ。差分の要旨を1行>

#### (2) 差分サマリ（最重要：数値）
- ROI差：<candidate - baseline>
- 損益差（円）：<candidate - baseline>
- 全体R：<baseline/candidate 共通>
- トリガー対象R：<条件に該当したR数>
- （任意）平均投資/平均回収（円/レース）：<あれば>

#### (3) 判定（GO / HOLD / NO / TEMP_GO）
- 判定：<GO/HOLD/NO/TEMP_GO>
- 根拠：<数値差分 + 母数ルールへの適合を1〜2行で>

#### (4) AIの所感（補助判断・非拘束）
- この数値結果になった理由（構造）：<1〜3行>
- 長期ROI観点の所感（リスク/副作用）：<1〜3行>
- 誤採用リスク／過小評価リスク：<1〜2行>
- 次の一手（何を変える/何を追加で見るか）：<1行>

> 注意：AIの所感は「数値判断を補強する」目的。  
> 数値差分がNO/HOLDでも、所感でGOに“覆さない”。


---

## 付録A（v26差分の要点：ハマりやすい“入口”だけ先に）
### A-1. 期間の正（T_end/T_start）
- **T_end = all_k_results.csv の max(date)**
- **T_start = T_end - 89日**
- 以後すべての取得・検証をこの範囲に固定（payout/features/backtest）

### A-2. 日付フォーマット統一（超重要）
- date-from/date-to は **YYYY-MM-DD** に統一（ハイフンなし混入は禁止）
- 0件化・極小CSV・サイレント縮退の最優先疑いポイント

### A-3. payoutは“短期疎通→90D本番”が基本
- いきなり90D本番は避け、短期チャンクで rows>0 を確認してから本番へ
- runlogは必ず残す（止まった/進まない切り分けに必要）


---

## 90D→反映フェーズ：改修スコープ（ユーザ意思決定・切替耐性テンプレ）


#### ■ 触ってよい範囲（今回の改修対象）
- **変更対象：スクリプトあり**
  - **`買い目一覧の出力（例：tickets_long.csv など）`を生成している処理（スクリプト/関数）に限定（※成果物名は案件ごとに埋める）**
  - 追加するのは **「条件分岐」だけ**（既存の判定・軸選定には触れない）
- **変更対象：ドキュメントは原則なし**
  - **RUNBOOK（意思決定ルール）は変更しない**
  - 反映した事実を残すために **LEDGER（または CHANGELOG）に1行追記のみ**（推奨）

#### ■ 具体的にやる変更（WHATを固定）
- 条件：**axis2 が 5 または 6 のレース**のみ
- 追加：**ケア枠（3連複）を追加**
  - 組み合わせ：`axis1 - axis2 - (候補上位c1 or c2)`
  - 追加金額：**+400円/対象レース**（固定）
- 方式：**スイッチ方式（推奨）**
  - ON：上記ケア枠を追加
  - OFF：出力が従来と完全一致

#### ■ 触ってはいけない範囲（禁止：ここを明文化）
- conf閾値
- S/A判定ロジック
- 軸選定（axis1/axis2算出方法）
- RUNBOOKの意思決定ルール本文


#### ■ 重要：スコープ拡張は“ユーザ承認”が前提（ガード）
- 本テンプレの「触ってはいけない範囲」は **無断では触らない**（事故防止）。
- ただし **長期ROI最大化のために必要**で、あなた（ユーザ）の合意がある場合はスコープ拡張してよい。
- スコープ拡張する場合は、反映フェーズ開始前に **台帳（LEDGER）の「ユーザ承認」欄へ** ①承認有無（未/済）②承認範囲（例：conf閾値まで）③承認日 を必ず記録する。

#### ■ 完了条件（DONE：切替後でも判断できる）
- スイッチOFFで実行 → **`tickets_long` が従来と完全一致**
- スイッチONで実行 →
  - **axis2=5/6 のレースだけ**買い目が増える
  - それ以外は従来と一致