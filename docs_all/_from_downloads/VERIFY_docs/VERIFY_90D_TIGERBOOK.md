# 90D虎の巻（Tigerbook） v0.1（章立てのみ）

## 0. この虎の巻の目的
- 90D検証で「世界線ズレ」「手順混在」「再現性崩壊」を最短で潰すための、判断・手順・典型トラブルの器。

## 1. WORLD概念（BL / BT）
- BL（analysis / 再計算・制約なし）
- BT（operation / 運用再現・CAP/除外あり）
- “混ぜると何が起きるか” のチェック観点

## 2. ゴール定義（90Dで何を確定するか）
- ゴール1：同条件なら同結果（BL/BTそれぞれ）
- ゴール2：意思決定（採用/不採用）をROI差分で固定
- 30d/90d/rolling の使い分け（窓固定の思想）

## 3. 入力と前処理の正本（何を揃えるか）
- K / fan / official features / payouts の正本
- dedupキー、key_overlap_rate、期間寄せの原則

## 4. 実行ルート（最短Runbook）
- BL（analysis）最短手順
- BT（operation）最短手順
- “やってはいけない混在” リスト（modeと制約の混在など）

## 5. 典型トラブル集（症状→原因→1行対処）
- 日付フォーマット混在（YYYYMMDD vs YYYY-MM-DD）
- Kフォルダ実体/リンク（junction問題）
- payouts不足/カバレッジ不足
- features重複（dedup漏れ）
- 固定名依存（Cフェーズ副作用）

## 6. 判断ログの残し方（再現性のための記録）

- **運用ルールの出力トレース（必須）**
  - `*_diagnostic.csv` に「除外されたか/理由」を残す（`excluded_flag`, `excluded_reason`）
  - 併せて `excluded_races_count`, `excluded_races_ratio` をサマリに残す（report or summary）
  - **採用済ルール A-4**：`excluded_by_axis2_56`（0/1）＋ `excluded_reason` に `"A-4 axis2 in {5,6}"`
- “世界線メタ” の固定項目（期間、CAP、除外、payouts、features、commit相当）
- CANON_INDEX / guardレポートの位置づけ

## 7. 引継ぎ（HANDOVER）に必ず書くこと
- WORLD（BL/BT）明記
- 重要要素（CAP/除外/期間/正本パス）
- C側への副作用注意（固定名依存）

## 90D意思決定ルール（v1.2：AI所感欄あり）

### 目的
- ユーザが「評価の解釈」を得意でなくても、**誤採用を防ぎつつ**意思決定できるようにする。
- 判断を委ねる場合、**可能な限り数値（ROI / 金額）で提示**する。

### 最低限の母数ルール（トリガー対象R）
- 原則：トリガー対象R **>= 30** で判定する
- 例外：トリガー対象R **20–29** は「条件付き判定（TEMP_GO / HOLD）」のみ許可
- トリガー対象R **< 20** は原則 **HOLD**（判断しない）
- 例外（20–29で判断してよい条件：全て必須）
  1) 差分損益（円）が十分大きい（目安：±10万円以上／90D換算）
  2) 改修が軽微（ケア枠・条件分岐のみ／モデル本体は不変更）
  3) 副作用が限定的（全体ROIが悪化していない）
  4) 暫定扱い（TEMP_GO 等）を明示する

### 出力フォーマット（ユーザに意思決定を委ねるときは必須）
以下を必ずセットで出す（**数値→判定→所感**の順で固定）：

#### (1) 何を比べた？
- baseline：<現行運用の定義（WORLD/期間/CAP/除外/正本パス）>
- candidate：<変更点は1つだけ。差分の要旨を1行>

#### (2) 差分サマリ（最重要：数値）
- ROI差：<candidate - baseline>
- 損益差（円）：<candidate - baseline>
- 全体R：<baseline/candidate 共通>
- トリガー対象R：<条件に該当したR数>
- （任意）平均投資/平均回収（円/レース）：<あれば>

#### (3) 判定（GO / HOLD / NO / TEMP_GO）
- 判定：<GO/HOLD/NO/TEMP_GO>
- 根拠：<数値差分 + 母数ルールへの適合を1〜2行で>

#### (4) AIの所感（補助判断・非拘束）
- この数値結果になった理由（構造）：<1〜3行>
- 長期ROI観点の所感（リスク/副作用）：<1〜3行>
- 誤採用リスク／過小評価リスク：<1〜2行>
- 次の一手（何を変える/何を追加で見るか）：<1行>

> 注意：AIの所感は「数値判断を補強する」目的。  
> 数値差分がNO/HOLDでも、所感でGOに“覆さない”。


## 出力フォーマット正本（必須：期間明記＋乖離検知）

90D検証の出力は「ユーザが今どの工程の何を見ているか」を一撃で理解できることが最優先。
よって、**結果の前に必ず「期間（Expected/Actual）」を明記し、一致判定（OK/NG）を出す**。

### 1) 期間（必須）
- Expected（ユーザ期待）: `YYYY-MM-DD..YYYY-MM-DD`（未指定なら `未指定`）
- Actual（今回算出）: `YYYY-MM-DD..YYYY-MM-DD`（必須）
- 判定: `OK（一致）` / `NG（不一致）`
- NGの場合は差分を1行で補足（例：Expected=... / Actual=...）

### 2) 比較（BL/BT × Baseline/Candidate 対比表：必須）
見出しは **`CAP / 除外場（運用制約）`** とし、値は **`OFF（BL）/ ON（BT）`** で表現する。

| 項目 | BL-Baseline | BL-Candidate | BT-Baseline | BT-Candidate |
|---|---|---|---|---|
| 世界線 | BL | BL | BT | BT |
| 期間 | 同一 | 同一 | 同一 | 同一 |
| payout | 同一 | 同一 | 同一 | 同一 |
| CAP / 除外場（運用制約） | OFF | OFF | ON | ON |
| スコア計算 | 同一 | 同一 | 同一 | 同一 |
| 変更点 | なし | （例）axis2=5/6除外 | なし | （例）axis2=5/6除外 |

### 3) 判断ガイド（必須）
- 現在位置：`BL比較` / `BT比較` / `rolling確認`
- 判断可否：`最終判断不可（BT未実施）` 等を明記
- 次工程：次に何を見るかを1行で固定表示
